{
    "collab_server" : "",
    "contents" : "################################################################################\n# Author: Julius Eberhard\n# Last Edit: 2016-09-12\n# Project: ECHSE evapotranspiration\n# Function: echsePost\n# Aim: Model Run and Data Postprocessing\n################################################################################\n\nechsePost <- function(engine,  # name of ECHSE engine\n                      et.choice,  # etp or eta\n                      ma.width,  # width of moving average filter in time units\n                      field.station,  # field station name\n                      comp = NA  # variable for comparison bet. model & obs\n                      ) {\n\n  system(paste0(\"cd ~/uni/projects/\", engine, \"/run; ./run cnf_default\"))\n\n  # SET AND LOAD ---------------------------------------------------------------\n\n  library(TTR)\n  results <- read.delim(paste0(\"~/uni/projects/\", engine,\n                               \"/run/output/test1.txt\"), sep=\"\\t\")\n\n  # POSTPROCESSING -------------------------------------------------------------\n\n  res.xts <- xts(results[, 2], \n                 order.by=as.POSIXct(results$end_of_interval, tz=\"UTC\"))\n  res.mean <- mean(results[, 2])\n\n  # PLOT -----------------------------------------------------------------------\n\n  if (comp == \"evap\") {\n  # evapotranspiration\n\n    # NORMAL PLOT\n    pdf(\"plot_et_comp.pdf\")\n\n    if (engine == \"evap_portugal\") {\n    # Portugal\n\n      ma.width <- ma.width\n      period <- seq(as.POSIXct(tstart), \n                    as.POSIXct(tend), by=\"1 hour\")\n      xl <- c(as.POSIXct(tstart), as.POSIXct(tend))\n      rad <- as.numeric(meteo.list[[3]][period])  # total incoming radiation\n      rad[is.na(rad)] <- 0\n      rad.ma <- runMean(rad, n=ma.width)\n      hum <- as.numeric(meteo.list[[6]][period])  # air humidity\n      hum[is.na(hum)] <- 0\n      hum.ma <- runMean(hum, n=ma.width)\n\n      layout(matrix(1:7, 7, 1), heights=c(.2, rep(.1, 5), .3))\n      if (field.station == \"HS\") {\n      # Hauptstation\n        radn <- as.numeric(HS.list[[1]][period])  # net radiation\n        radn[is.na(radn)] <- 0\n        radn.ma <- runMean(radn, n=ma.width)\n        temp <- as.numeric(HS.list[[2]][period])  # air temperature\n        temp[is.na(temp)] <- mean(as.numeric(HS.list[[2]]))\n        temp.ma <- runMean(temp, n=ma.width)\n        sohe <- as.numeric(HS.list[[3]][period])  # soil heat flux\n        sohe[is.na(sohe)] <- 0\n        sohe.ma <- runMean(sohe, n=ma.width)\n        somo <- as.numeric(HS.list[[4]][period])  # soil moisture\n        somo[is.na(somo)] <- wc_res\n        somo.ma <- runMean(somo, n=ma.width)\n        wind <- as.numeric(HS.list[[11]][period])  # wind\n        wind[is.na(wind)] <- 0\n        wind.ma <- runMean(wind, n=ma.width)\n\n        par(mar=c(0, 5, 5, 2))\n        plot(period, rad.ma, xlim=xl, type=\"l\", \n             ylab=(Rad~(W~m^{-2})), xaxt=\"n\", main=c(engine, et.choice))\n        #lines(period, radn.ma, xlim=xl, type=\"l\", col=2)\n        #legend(\"topright\", c(\"global rad.\", \"net rad.\"), lty=1, col=c(1, 2))\n        par(mar=c(0, 5, 0, 2))\n        plot(period, temp.ma, xlim=xl, type=\"l\",\n             ylab=(Temp~({}^o~C)), xaxt=\"n\")\n        plot(period, sohe.ma, xlim=xl, type=\"l\",\n             ylab=(SHF~(W~m^{-2})), xaxt=\"n\")\n        plot(period, somo.ma, xlim=xl, type=\"l\",\n             ylab=expression(S.moist~({}-{})), xaxt=\"n\")\n        plot(period, hum.ma, xlim=xl, type=\"l\",\n             ylab=(Rel.hum.~(\"%\")), xaxt=\"n\")\n        plot(period, wind.ma, xlim=xl, type=\"l\",\n             ylab=(Wind~(m~s^{-1})), xaxt=\"n\")\n        par(mar=c(4, 5, 0, 2))\n        plot(period, as.numeric(HS.list[[8]][period]), xlim=xl,\n             ylim=c(-.1, 2), xlab=\"\", ylab=(ET~(mm)), type=\"l\", col=\"gray40\")\n      } else {\n      # Nebenstation A\n        radn <- as.numeric(NSA.list[[1]][period])  # net radiation\n        radn[is.na(radn)] <- 0\n        radn.ma <- runMean(radn, n=ma.width)\n        temp <- as.numeric(NSA.list[[2]][period])  # air temperature\n        temp[is.na(temp)] <- mean(as.numeric(NSA.list[[2]]))\n        temp.ma <- runMean(temp, n=ma.width)\n        sohe <- as.numeric(NSA.list[[3]][period])  # soil heat flux\n        sohe[is.na(sohe)] <- 0\n        sohe.ma <- runMean(sohe, n=ma.width)\n        somo <- as.numeric(NSA.list[[4]][period])  # soil moisture\n        somo[is.na(somo)] <- wc_res\n        somo.ma <- runMean(somo, n=ma.width)\n        wind <- as.numeric(NSA.list[[11]][period])  # wind\n        wind[is.na(wind)] <- 0\n        wind.ma <- runMean(wind, n=ma.width)\n\n        par(mar=c(0, 5, 5, 2))\n        plot(period, rad.ma, xlim=xl, type=\"l\",\n             ylab=(Rad~(W~m^{-2})), xaxt=\"n\", main=c(engine, et.choice))\n        #lines(index(NSA.list[[1]]), radn.ma, xlim=xl, type=\"l\", col=2)\n        #legend(\"topright\", c(\"global rad.\", \"net rad.\"), lty=1, col=c(1, 2))\n        par(mar=c(0, 5, 0, 2))\n        plot(period, temp.ma, xlim=xl, type=\"l\", \n             ylab=(Temp~({}^o~C)), xaxt=\"n\")\n        plot(period, sohe.ma, xlim=xl, type=\"l\", \n             ylab=(SHF~(W~m^{-2})), xaxt=\"n\")\n        plot(period, somo.ma, xlim=xl, type=\"l\", \n             ylab=expression(S.moist~({}-{})), xaxt=\"n\")\n        plot(period, hum.ma, xlim=xl, type=\"l\", \n             ylab=(Rel.hum.~(\"%\")), xaxt=\"n\")\n        plot(period, wind.ma, xlim=xl, type=\"l\", \n             ylab=(Wind~(m~s^{-1})), xaxt=\"n\")\n        par(mar=c(4, 5, 0, 2))\n        plot(period, as.numeric(NSA.list[[8]][period]), xlim=xl, \n             ylim=c(-.1, 2), xlab=\"\", ylab=(ET~(mm)), type=\"l\", col=\"gray40\")\n      }\n      par(new=T)\n      plot(index(res.xts), as.numeric(res.xts), xlim=xl, ylim=c(-.1, 2), col=2,\n           xlab=\"Date\", ylab=\"\", type=\"l\")\n      legend(\"topright\", c(\"simulation\", \"observation\"), lty=1,\n             col=c(2, \"gray40\"))\n\n    } else {\n    # Morocco\n\n      ma.width <- ma.width\n      period <- seq(as.POSIXct(tstart, tz=\"UTC\"), \n                    as.POSIXct(tend, tz=\"UTC\"), by=\"1 hour\")\n      xl <- c(as.POSIXct(tstart, tz=\"UTC\"), as.POSIXct(tend, tz=\"UTC\"))\n      rad <- as.numeric(meteo.list[[2]])  # total incoming radiation\n      rad[is.na(rad)] <- 0\n      rad.ma <- runMean(rad, n=ma.width)\n      hum <- as.numeric(meteo.list[[1]])  # air humidity\n      hum[is.na(hum)] <- 0\n      hum.ma <- runMean(hum, n=ma.width)\n      radn.ma <- rad.ma * .8  # net radiation\n      temp <- as.numeric(meteo.list[[3]])  # air temperature\n      temp[is.na(temp)] <- mean(as.numeric(meteo.list[[4]]))\n      temp.ma <- runMean(temp, n=ma.width)\n      sohe.ma <- NA  # soil heat flux\n      somo.ma <- .9 * wc_sat  # soil moisture\n      wind <- as.numeric(meteo.list[[4]])  # wind\n      wind[is.na(wind)] <- 0\n      wind.ma <- runMean(wind, n=ma.width)\n      # calculate daily ET sums for comparison with observations\n      # -> maybe faster with apply.daily(..., sum)?\n      etsum <- c()\n      for (i in 1:365)\n        etsum[i] <- sum(as.numeric(res.xts[format(index(res.xts), \"%j\") == i,\n                                           1]))\n\n      layout(matrix(1:7, 7, 1), heights=c(.2, rep(.1, 5), .3))\n      par(mar=c(0, 5, 5, 2))\n      plot(index(meteo.list[[1]]), rad.ma, xlim=xl, type=\"l\", xlab=\"\",\n           ylab=(Rad~(W~m^{-2})), xaxt=\"n\", main=c(engine, et.choice))\n      #lines(index(meteo.list[[1]]), radn.ma, xlim=xl, type=\"l\", col=2)\n      #legend(\"topright\", c(\"global rad.\", \"net rad.\"), col=c(1, 2))\n      par(mar=c(0, 5, 0, 2))\n      plot(index(meteo.list[[1]]), temp.ma, xlim=xl, type=\"l\", \n           ylab=(Temp~({}^o*C)), xaxt=\"n\")\n      plot(index(meteo.list[[1]]), rep(sohe.ma, length(index(meteo.list[[1]]))), \n           xlim=xl, ylim=c(0, 0), type=\"l\", ylab=(SHF~(W~m^{-2})), xaxt=\"n\")\n      plot(index(meteo.list[[1]]), rep(somo.ma, length(index(meteo.list[[1]]))),\n           xlim=xl, type=\"l\", ylab=expression(S.moist~({}-{})), xaxt=\"n\")\n      plot(index(meteo.list[[1]]), hum.ma, xlim=xl, type=\"l\",\n           ylab=(Rel.hum.~(\"%\")), xaxt=\"n\")\n      plot(index(meteo.list[[1]]), wind.ma, xlim=xl, type=\"l\",\n           ylab=(Wind~(m~s^{-1})), xaxt=\"n\")\n      par(mar=c(4, 5, 0, 2))\n      plot(index(eta.day.xts), as.numeric(eta.day.xts), xlim=xl,\n           ylim=c(-1, max(c(as.numeric(eta.day.xts), etsum))), xlab=\"\",\n           ylab=(ET~(mm)), type=\"l\", col=2)\n      lines(seq(as.POSIXct(\"2013-01-01\"), as.POSIXct(\"2013-12-31\"), by=\"day\"),\n            etsum)\n      legend(\"topright\", c(\"simulation\", \"observation\"), lty=1, col=c(1, 2))\n    }\n\n    dev.off()\n\n    # CUMULATIVE PLOT\n    pdf(\"plot_et_cum.pdf\")\n\n    if (engine == \"evap_portugal\") {\n    # Portugal\n      plot(cumsum(res.xts), ylim=c(0, 50), main=paste(engine, \"cumulative\"),\n           ylab=\"cumulative ET (mm)\")\n      if (field.station==\"HS\") {\n      # Hauptstation\n        lines(cumsum(na.exclude(HS.list[[8]][index(HS.list[[8]]) >=\n                                             index(res.xts)[1]])),\n              col=2)\n      } else {\n      # Nebenstation A\n        lines(cumsum(na.exclude(NSA.list[[8]][index(NSA.list[[8]]) >=\n                                              index(res.xts)[1]])),\n              col=2)\n        legend(\"topright\", c(\"simulation\", \"observation\"), lty=1, col=c(1, 2))\n      }\n    } else {\n    # Morocco\n      plot(cumsum(res.xts), ylim=c(0, 50), main=paste(engine, \"cumulative\"),\n           ylab=\"cumulative ET (mm)\")\n      lines(cumsum(na.exclude(eta.day.xts[index(eta.day.xts) >=\n                                          index(res.xts)[1]])), col=2)\n      legend(\"topright\", c(\"simulation\", \"observation\"), lty=1, col=c(1, 2))\n    }\n    \n    dev.off()\n\n  } else if (comp == \"glorad\") {\n  # global radiation\n\n    # NORMAL PLOT\n    if (tail(strsplit(engine, \"_\")[[1]], 1) == \"portugal\") {\n      rad.plot <- apply.daily(meteo.list[[3]], mean)\n      index(rad.plot) <- as.POSIXlt(index(rad.plot))\n      index(rad.plot)$hour <- \"00\"\n    } else {\n      rad.plot <- apply.daily(meteo.list[[2]], mean)\n      index(rad.plot) <- as.POSIXlt(index(rad.plot))\n      index(rad.plot)$hour <- \"00\"\n    }\n\n    pdf(paste0(\"plot_\", comp, \"_comp.pdf\"))\n    \n    plot(res.xts, ylim=c(0, 500), main=engine, ylab=comp)\n    lines(rad.plot, col=2)\n    legend(\"topright\", legend=c(\"simulation\", \"observation\"), col=c(1, 2),\n           lty=c(1, 1))\n\n    dev.off()\n\n    # CUMULATIVE PLOT\n    pdf(\"plot_glorad_cum.pdf\")\n\n    plot(cumsum(res.xts), ylim=c(0, 50000), main=paste(engine, \"cumulative\"),\n         ylab=\"cumulative radiation (Wm2)\")\n    lines(cumsum(rad.plot[index(rad.plot) >= index(res.xts)[1]]), col=2)\n    legend(\"topright\", legend=c(\"simulation\", \"observation\"), col=c(1, 2),\n           lty=c(1, 1))\n\n    dev.off()\n\n  } else if (comp == \"rad_net\") {\n  # net radiation\n\n    # NORMAL PLOT\n    if (tail(strsplit(engine, \"_\")[[1]], 1) == \"portugal\") {\n      rnet.plot <- get(paste0(field.station, \".list\"))[[1]]\n      pdf(paste0(\"plot_\", comp, \"_comp.pdf\"))\n\n      plot(res.xts[round(length(res.xts) / 3):round(length(res.xts) / 1.5)],\n           ylim=c(0, 800), main=engine, ylab=comp)\n      lines(rnet.plot, col=2)\n      legend(\"topright\", legend=c(\"simulation\", \"observation\"), col=c(1, 2),\n             lty=c(1, 1))\n\n      dev.off()\n    }\n\n    # CUMULATIVE PLOT\n    if (tail(strsplit(engine, \"_\")[[1]], 1) == \"portugal\") {\n      pdf(\"plot_rad_net_cum.pdf\")\n\n      plot(cumsum(res.xts), ylim=c(1, 30000), main=paste(engine, \"cumulative\"),\n           ylab=\"cumulative net radiation (Wm2)\")\n      lines(cumsum(rnet.plot[index(rnet.plot) >= index(res.xts)[1]]), col=2)\n      legend(\"topright\", legend=c(\"simulation\", \"observation\"), col=c(1, 2),\n             lty=c(1, 1))\n\n      dev.off()\n    }\n\n  } else if (comp == \"soilheat\") {\n  # soil heat flux\n\n    # NORMAL PLOT\n    if (tail(strsplit(engine, \"_\")[[1]], 1) == \"portugal\") {\n      sheat.plot <- get(paste0(field.station, \".list\"))[[3]]\n      pdf(paste0(\"plot_\", comp, \"_comp.pdf\"))\n      \n      plot(res.xts, ylim=c(-20, 150), main=engine, ylab=comp)\n      lines(sheat.plot, col=2)\n      legend(\"topright\", legend=c(\"simulation\", \"observation\"), col=c(1, 2),\n             lty=c(1, 1))\n      \n      dev.off()\n    }\n\n    # CUMULATIVE PLOT\n    if (tail(strsplit(engine, \"_\")[[1]], 1) == \"portugal\") {\n      pdf(\"plot_soilheat_cum.pdf\")\n\n      plot(cumsum(res.xts), ylim=c(-100, 1800),\n           main=paste(engine, \"cumulative\"),\n           ylab=\"cumulative soil heat flux (Wm2)\")\n      lines(cumsum(sheat.plot[index(sheat.plot) >= index(res.xts)[1]]), col=2)\n      legend(\"topright\", legend=c(\"simulation\", \"observation\"), col=c(1, 2),\n             lty=c(1, 1))\n\n      dev.off()\n    }\n\n  }\n\n  # return mean evapotranspiration for sensitivity analysis\n  #return(res.mean)\n\n}",
    "created" : 1473327998503.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2272421708",
    "id" : "23BC41B",
    "lastKnownWriteTime" : 1475257234,
    "last_content_update" : 1475257234458,
    "path" : "~/boxup/whk_echse/echsePost.R",
    "project_path" : "echsePost.R",
    "properties" : {
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}