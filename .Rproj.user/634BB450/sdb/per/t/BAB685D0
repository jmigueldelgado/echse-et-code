{
    "collab_server" : "",
    "contents" : "################################################################################\n# Author: Julius Eberhard\n# Last Edit: 2016-09-05\n# Project: ECHSE evapotranspiration\n# Function: echseParEst\n# Aim: Estimation of Model Parameters from Observations\n################################################################################\n\nechseParEst <- function(parname,        # name of parameter group to estimate\n                                        # [radex_[a/b], fcorr_[a/b], emis_[a/b]]\n                        rxfile = NA,    # file with extraterrestrial rad. data*\n                        grfile = NA,    # file with global radiation data*\n                        rnetfile = NA,  # file with net radiation data*\n                        sheatfile = NA, # file with soil heat flux data*\n                                        # *Supply complete file path!\n                        lat = 0,        # latitude for calculating sunrise/-set\n                        lon = 0,        # longitude for... ditto\n                        plots = T       # plots for visual diagnosis?\n                        ) {\n\n  if (length(grep(\"radex\", parname)) != 0) {\n  # radex parameters\n\n    # read extraterrestrial radiation\n    radex <- read.delim(rxfile, sep=\"\\t\")\n    radex.xts <- xts(radex[, 2], order.by=as.POSIXct(radex[, 1], tz=\"UTC\"))\n    # read global radiation input\n    glorad <- read.delim(grfile, sep=\"\\t\")\n    glorad.xts <- xts(glorad[, 2], order.by=as.POSIXct(glorad[, 1], tz=\"UTC\"))\n    # select common time window\n    tstart <- max(index(radex.xts)[1], index(glorad.xts)[1])\n    tend <- min(tail(index(radex.xts), 1), tail(index(glorad.xts), 1))\n    rx.full <- radex.xts[paste0(tstart, \"/\", tend)]\n    gr.full <- glorad.xts[paste0(tstart, \"/\" ,tend)]\n    # restrict to times between 8:00 and 16:00 to avoid odd night effects\n    rx <- rx.full[as.numeric(format(index(rx.full), \"%H\")) < 17 &\n                  as.numeric(format(index(rx.full), \"%H\")) > 7]\n    gr <- gr.full[as.numeric(format(index(gr.full), \"%H\")) < 17 &\n                  as.numeric(format(index(gr.full), \"%H\")) > 7]\n    # calculate ratio of radex and glorad\n    rad.ratio <- as.numeric(gr) / as.numeric(rx)\n    r.max <- mean(sapply(8:16, function(x) {\n                                 max(rad.ratio[as.numeric(format(index(rx),\n                                                                 \"%H\")) == x])\n                               }))\n    if (plots) {\n      # plot histogram of calculated ratios\n      hist(rad.ratio)\n      # plot rad.ratio over hours of day to detect subdaily trends\n      plot(as.numeric(format(index(rx), \"%H\")), rad.ratio,\n           xlab=\"hour of day\", ylab=\"glorad / radex\")\n      # plot extraterr. and global radiation to detect time shifts\n      plot(rx.full, type=\"l\", ylim=c(0, max(as.numeric(rx.full))), xlab=\"date\",\n           ylab=\"rad (black: rx, red: gr)\", main=\"\")\n      lines(gr.full, col=2)\n    }\n    # return parameters\n    out <- c(quantile(rad.ratio, .01),  # radex_a\n             r.max - quantile(rad.ratio, .01))  # radex_b\n    names(out) <- c(\"radex_a\", \"radex_b\")\n    out\n    \n  } else if (length(grep(\"fcorr\", parname)) != 0) {\n  # fcorr parameters\n\n    c(1.35, -.35)  # There is no good method to estimate cloudiness correction.\n\n  } else if (length(grep(\"emis\", parname)) != 0) {\n  # emis parameters\n\n    c(.34, -.14)\n\n  } else if (length(grep(\"f\", parname)) != 0) {\n  # soil heat fraction parameters\n\n    # load RAtmosphere library for calculating sunrise/sunset hours\n    library(RAtmosphere)\n    # read net radiation (internally calculated)\n    rad_net <- read.delim(rnetfile, sep=\"\\t\")\n    rad_net.xts <- xts(rad_net[, 2],\n                       order.by=as.POSIXct(rad_net[, 1], tz=\"UTC\"))\n    # read soil heat flux (record)\n    soilheat <- read.delim(sheatfile, sep=\"\\t\")\n    soilheat.xts <- xts(soilheat[, 2],\n                        order.by=as.POSIXct(soilheat[, 1], tz=\"UTC\"))\n    # select common time window\n    tstart <- max(index(rad_net.xts)[1], index(soilheat.xts)[1])\n    tend <- min(tail(index(rad_net.xts), 1), tail(index(soilheat.xts), 1))\n    rnet <- rad_net.xts[paste0(tstart, \"/\", tend)]\n    sheat <- soilheat.xts[paste0(tstart, \"/\" ,tend)]\n    # divide into daytime and nighttime\n    sun <- suncalc(as.numeric(format(index(rnet), \"%j\")), lat, lon)\n    rnet.day <- rnet[as.numeric(format(index(rnet), \"%H\")) > sun$sunrise &\n                       as.numeric(format(index(rnet), \"%H\")) < sun$sunset]\n    rnet.night <- rnet[as.numeric(format(index(rnet), \"%H\")) < sun$sunrise |\n                         as.numeric(format(index(rnet), \"%H\")) > sun$sunset]\n    sheat.day <- sheat[as.numeric(format(index(sheat), \"%H\")) > sun$sunrise &\n                         as.numeric(format(index(sheat), \"%H\")) < sun$sunset]\n    sheat.night <- sheat[as.numeric(format(index(sheat), \"%H\")) < sun$sunrise |\n                           as.numeric(format(index(sheat), \"%H\")) > sun$sunset]\n    # return parameters\n    c(mean(sheat.day, na.rm=T) / mean(rnet.day, na.rm=T),  # f_day\n      mean(sheat.night, na.rm=T) / mean(rnet.night, na.rm=T))  # f_night\n\n  } else {\n    \n    stop(\"Unknown parameter name! Possible choices: radex_*, fcorr_*, f_*,\n         emis_*.\")\n  \n  }\n  \n}\n",
    "created" : 1473681510269.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1404035272",
    "id" : "BAB685D0",
    "lastKnownWriteTime" : 1473688355,
    "last_content_update" : 1473688355122,
    "path" : "~/boxup/whk_echse/echseParEst.R",
    "project_path" : "echseParEst.R",
    "properties" : {
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}